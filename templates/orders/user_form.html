{% extends "base.html" %}
{% load static %}

{% block title %}{{ titulo }} · ServicioTech{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-lg border-0 rounded-lg">
            <div class="card-header bg-primary text-white d-flex align-items-center">
                <i class="bi bi-person-fill-add me-2 fs-4"></i>
                <h3 class="fw-bold my-2">{{ titulo }}</h3>
            </div>
            <div class="card-body p-4">
                <form method="post" id="user-form">
                    {% csrf_token %}

                    {% if form.errors %}
                        <div class="alert alert-danger" role="alert">
                            <strong>¡Atención!</strong> Revisa los siguientes errores:
                            {{ form.non_field_errors }}
                            <ul>
                                {% for field in form %}
                                    {% if field.errors %}<li>{{ field.label }}: {{ field.errors|striptags }}</li>{% endif %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    {# 1. Datos Personales #}
                    <h5 class="fw-bold text-primary mb-3 mt-4">1. Datos Personales</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Nombre(s)</label>
                            {{ form.first_name }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Apellidos</label>
                            {{ form.last_name }}
                        </div>
                        <div class="col-12">
                            <label class="form-label">Correo Electrónico</label>
                            {{ form.email }}
                        </div>
                    </div>

                    {# 2. Datos de Acceso #}
                    <h5 class="fw-bold text-primary mb-3 mt-5">2. Datos de Acceso</h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Usuario (Login)</label>
                            {{ form.username }}
                        </div>
                        
                        {# Contraseñas #}
                        <div class="col-md-6">
                            <label class="form-label">Contraseña</label>
                            {{ form.password }}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Confirmar contraseña</label>
                            {{ form.confirm_password }}
                            <div id="password-error-msg" class="text-danger small fw-bold mt-1"></div>
                        </div>
                    </div>

                    {# 3. Permisos y Firma #}
                    <h5 class="fw-bold text-primary mb-3 mt-5">3. Permisos y Firma</h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Rol del Usuario</label>
                            {{ form.role }}
                            <div class="form-text text-muted">Selecciona el rol para ver opciones de firma.</div>
                        </div>
                    </div>

                    {# Área de Firma DIGITAL #}
                    <div id="signature-area" class="mt-4 p-3 border rounded" style="display:none;">
                        <h6 class="fw-bold mb-3">Firma Digital del Usuario</h6>
                        <p class="text-muted small">Dibuja la firma aquí (Requerida para Ingenieros, opcional para Visores).</p>
                        
                        <canvas id="signature-pad" class="border bg-light rounded w-100" height="150" style="touch-action: none; cursor: crosshair;"></canvas>
                        
                        <div class="d-flex justify-content-end mt-2">
                            <button type="button" class="btn btn-outline-danger btn-sm me-2" id="clear-signature">Borrar</button>
                            <span class="btn btn-sm btn-outline-secondary disabled" id="save-signature-status">Sin firma</span>
                        </div>
                        
                        {{ form.firma_b64 }} {# Campo oculto #}
                    </div>

                    <div class="d-flex justify-content-end mt-4">
                        <a href="{% url 'orders:user_list' %}" class="btn btn-secondary me-2">Cancelar</a>
                        <button type="submit" class="btn btn-primary" id="submit-btn">Guardar Usuario</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# --- AQUÍ ESTABA EL ERROR: CAMBIAMOS 'extra_js' POR 'scripts' --- #}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. VALIDACIÓN DE CONTRASEÑAS
        const pass1 = document.getElementById('id_password');
        const pass2 = document.getElementById('id_confirm_password');
        const errorMsg = document.getElementById('password-error-msg');

        function validarPasswords() {
            if (!pass1 || !pass2) return;
            const v1 = pass1.value;
            const v2 = pass2.value;

            if (v1 === '' && v2 === '') {
                pass2.classList.remove('is-invalid', 'is-valid');
                errorMsg.textContent = "";
                return;
            }

            if (v1 !== v2) {
                pass2.classList.add('is-invalid');
                pass2.classList.remove('is-valid');
                errorMsg.textContent = "Las contraseñas no coinciden.";
            } else {
                pass2.classList.remove('is-invalid');
                pass2.classList.add('is-valid');
                errorMsg.textContent = "";
            }
        }

        if (pass1 && pass2) {
            pass1.addEventListener('keyup', validarPasswords);
            pass2.addEventListener('keyup', validarPasswords);
        }

        // 2. LÓGICA DE FIRMA
        const roleSelect = document.getElementById('id_role');
        const signatureArea = document.getElementById('signature-area');
        const canvas = document.getElementById('signature-pad');
        const signatureInput = document.getElementById('id_firma_b64');
        let signaturePad = null;

        function initPad() {
            if (canvas && !signaturePad) {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });

                signaturePad.addEventListener("endStroke", () => {
                    if (!signaturePad.isEmpty()) {
                        signatureInput.value = signaturePad.toDataURL();
                        document.getElementById('save-signature-status').textContent = "Firma Lista";
                        document.getElementById('save-signature-status').className = "btn btn-sm btn-success disabled";
                    }
                });
            }
        }

        function toggleSignature() {
            const role = roleSelect.value;
            if (role === 'ingeniero' || role === 'visor' || role === 'superuser') {
                signatureArea.style.display = 'block';
                if (!signaturePad) setTimeout(initPad, 100); 
            } else {
                signatureArea.style.display = 'none';
            }
        }

        if (roleSelect) {
            roleSelect.addEventListener('change', toggleSignature);
            toggleSignature(); 
        }

        document.getElementById('clear-signature').addEventListener('click', function() {
            if (signaturePad) signaturePad.clear();
            signatureInput.value = '';
            document.getElementById('save-signature-status').textContent = "Sin firma";
            document.getElementById('save-signature-status').className = "btn btn-sm btn-outline-secondary disabled";
        });
    });
</script>
{% endblock %}