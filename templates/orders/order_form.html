{% extends "orders/base.html" %}
{% load static %}
{% block title %}Nueva orden · ServicioTech{% endblock %}

{% block content %}
<form id="order-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <div class="row g-4 align-items-start">

    <!-- COLUMNA IZQUIERDA: Datos del servicio + Materiales -->
    <div class="col-12 col-lg-8">

      <!-- Datos del servicio -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h5 m-0">Datos del servicio</h2>
            <span class="badge text-bg-secondary">Nuevo</span>
          </div>
          <p class="text-muted small mb-4">Completa la información general del servicio.</p>

          <!-- TIP: para garantizar que todo se renderiza, usamos {{ form.as_p }}.
               Si quieres luego lo maquetamos campo por campo. -->
          <div class="pretty-form">
            {{ form.as_p }}
          </div>

          <!-- Si tienes estos campos, se verán en grid (si no, no pasa nada) -->
          <div class="row g-3 mt-2">
            {% if form.fecha_servicio %}
              <div class="col-12 col-md-4">
                {{ form.fecha_servicio.label_tag }}
                {{ form.fecha_servicio }}
              </div>
            {% endif %}
            {% if form.cliente_nombre %}
              <div class="col-12 col-md-4">
                {{ form.cliente_nombre.label_tag }}
                {{ form.cliente_nombre }}
              </div>
            {% endif %}
            {% if form.ingeniero_nombre %}
              <div class="col-12 col-md-4">
                {{ form.ingeniero_nombre.label_tag }}
                {{ form.ingeniero_nombre }}
              </div>
            {% endif %}
          </div>

          {% if form.titulo or form.descripcion %}
            <hr class="my-4">
            <h6 class="text-muted fw-bold mb-3">Descripción del trabajo</h6>
            <div class="row g-3">
              {% if form.titulo %}
                <div class="col-12">
                  {{ form.titulo.label_tag }}
                  {{ form.titulo }}
                </div>
              {% endif %}
              {% if form.descripcion %}
                <div class="col-12">
                  {{ form.descripcion.label_tag }}
                  {{ form.descripcion }}
                </div>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Materiales -->
      <div class="card shadow-sm border-0 mt-4">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h6 m-0">Materiales utilizados</h2>
          </div>
          <p class="text-muted small mb-3">Registra refacciones o consumibles usados.</p>

          {{ formset.management_form }}
          <div class="vstack gap-3">
            {% for f in formset %}
              <div class="border rounded-3 p-3 bg-light-subtle">
                {{ f.as_p }}
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

    </div>

    <!-- COLUMNA DERECHA: Firma + Acciones -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm border-0 position-sticky" style="top: 1rem; z-index: 1;">
        <div class="card-body p-4">
          <h2 class="h6 mb-3">Firma del cliente</h2>
          <p class="text-muted small">La casilla de firma es estable y no “salta” al firmar desde el teléfono.</p>

          <div id="signature-wrapper" class="signature-wrapper">
            <canvas id="signature-canvas"></canvas>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="sig-clear">Limpiar</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="sig-undo">Deshacer</button>
          </div>
          <input type="hidden" name="signature_data" id="signature-data">

          <hr class="my-4">

          <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" type="submit">
              Guardar orden
            </button>
            <a class="btn btn-light" href="{% url 'orders:list' %}">Cancelar</a>
          </div>
        </div>
      </div>
    </div>

  </div>
</form>
{% endblock %}
