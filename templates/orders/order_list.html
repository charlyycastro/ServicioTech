{% extends 'orders/base.html' %}
{% load static %}

{% block extra_css %}
<style>
  .card--compact .card-body{ padding: 1rem }
  .table-compact td, .table-compact th{ padding:.4rem .6rem; vertical-align: middle; }
  .clickable-row{ cursor:pointer }
</style>
{% endblock %}

{% block content %}
<div class="card shadow-sm card--compact">
  <div class="card-body">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-2">
      <h1 class="h6 mb-0">Órdenes</h1>
      <a class="btn btn-primary btn-sm" href="{% url 'orders:create' %}">Nueva orden</a>
    </div>

    <!-- Buscador mínimo -->
    <form method="get" class="d-flex gap-2 mb-2">
      <input type="text" name="q" value="{{ q|default:'' }}" class="form-control form-control-sm"
             placeholder="Buscar por folio, cliente o título…">
      <button class="btn btn-dark btn-sm" type="submit">Filtrar</button>
    </form>

    <div class="table-responsive">
      <table class="table table-hover table-sm table-compact">
        <thead class="table-light">
          <tr>
            <th>Folio</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Título</th>
          </tr>
        </thead>
        <tbody>
          {% for o in ordenes %}
          <tr class="clickable-row" data-href="{% url 'orders:detail' o.pk %}">
            <td><a href="{% url 'orders:detail' o.pk %}" class="text-decoration-none">{{ o.folio }}</a></td>
            <td>{{ o.fecha_servicio|date:'Y-m-d' }}</td>
            <td>{{ o.cliente_nombre }}</td>
            <td class="text-truncate" style="max-width: 420px">{{ o.titulo }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center text-muted py-4">Sin resultados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
    <nav class="mt-2">
      <ul class="pagination pagination-sm mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page_obj.previous_page_number }}">«</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
        {% endif %}

        <li class="page-item active"><span class="page-link">{{ page_obj.number }} / {{ paginator.num_pages }}</span></li>

        {% if page_obj.has_next %}
          <li class="page-item"><a class="page-link" href="?q={{ q }}&page={{ page_obj.next_page_number }}">»</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Fila clickeable (sin interferir con enlaces)
  document.querySelectorAll('.clickable-row').forEach(function(row){
    row.addEventListener('click', function(e){
      if (e.target.closest('a, button, input, label')) return;
      const href = this.dataset.href;
      if (href) window.location = href;
    });
  });
</script>
{% endblock %}
